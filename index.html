<!DOCTYPE html>
<html>
<meta charset="UTF-8">
<link href="./css/index1style.css" rel="stylesheet">

<head>
    <meta charset="UTF-8">
    <title>typo janchi2019</title>
    <script src="https://www.gstatic.com/firebasejs/6.2.4/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.2.4/firebase-firestore.js"></script>
    <script src="./js/config.js"></script>
</head>

<body id="print" ng-app="janchi2019" ng-controller="janchiControl">

    <div id="cloneinput">
        <div id="topmenu">
            <p id="nowlength">{{textcontents.length}} / {{max_value}}</p>
        </div>
        <h1 id="ttinput" ng-model="inval" ng-attr-style="font-size: {{inval}}vw !important;">{{textcontents}}</h1>
    </div>
    <input id="origin_input" ng-model="textcontents" ng-model-options="{ allowInvalid: true }" type="text"
        maxlength="{{max_value}}" ng-keyup="nam()" autofocus />
</body>
<script src="https://code.jquery.com/jquery-3.4.1.min.js"
    integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.7.8/angular.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.7.8/angular-animate.min.js"></script>
<script src="https://cdn.firebase.com/libs/angularfire/2.3.0/angularfire.min.js"></script>
<script src="./js/html2canvas_min.js"></script>
<script src="./js/FileSaver.js"></script>

<script>
    var app = angular.module('janchi2019', ["firebase", "ngAnimate"]);
    var serverUrl = 'http://localhost:3000/';
    app.controller('janchiControl', function ($scope, $http, $firebaseArray, $window) {
        $scope.textcontents = "";
        $scope.copycon = $scope.textcontents;
        $scope.max_value = 50;
        $scope.max_inval = 25;
        $scope.min_inval = 5;
        $scope.inval = 25;
        $scope.exportDiv = function (div) {
            html2canvas(div, { scale: 0.533 }).then(function (canvas) {
                var rotCanvas = document.createElement("canvas");
                rotCanvas.width = canvas.height, rotCanvas.height = canvas.width;
                var rctx = rotCanvas.getContext("2d");
                rctx.translate(rotCanvas.width * 0.5, rotCanvas.height * 0.5);
                rctx.rotate(-Math.PI * 0.5);
                rctx.drawImage(canvas, -canvas.width * 0.5, -canvas.height * 0.5);
                //가로 캔버스//
                //$scope.data64 = canvas.toDataURL().replace(/\s/g, '+').replace(/^data:image\/png;base64,/, '');
                //세로 캔버스//
                $scope.data64 = rotCanvas.toDataURL().replace(/\s/g, '+').replace(/^data:image\/png;base64,/, '');
                $http.post(serverUrl, { "valueis": $scope.data64 }).then(function (req) {
                    console.log("posted successfully");
                }).catch(function (req) {
                    console.error("error in posting");
                });
            })
        }

        $scope.sendmss = function () {
            if ($scope.textcontents.length < 1) {
                console.log("no way!");
                return;
            } else {
                db.collection("janchi_data").add({
                    contents: $scope.textcontents,
                    date: firebase.firestore.Timestamp.now(),
                });
                $scope.exportDiv(document.getElementById('cloneinput'));
                $scope.textcontents = "";
            }
        }
        $(document).keypress(function (e) {
            if (e.which == 13) {
                $scope.sendmss();
            }
        });
        $scope.nam = function () {
            if ($scope.textcontents.length > 0) {
                $scope.inval = $scope.max_inval / ($scope.textcontents.length * 0.6);
                if ($scope.inval < $scope.min_inval) {
                    $scope.inval = $scope.min_inval;
                } else if ($scope.inval > $scope.max_inval) {
                    $scope.inval = $scope.max_inval;
                }
                if ($scope.textcontents.length >= $scope.max_value) {
                    console.log("delete");
                    $scope.textcontents = $scope.textcontents.slice(0, -1);
                } else {
                    return;
                }
            }
            console.log($scope.inval);
        }
        $scope.bigsmall = function () {
            console.log("fuc! ");
        }
    });
</script>

</html>